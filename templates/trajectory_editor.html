{% extends 'base.html' %}

{% block title %}Редактор траектории{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        display: flex;
        height: calc(100vh - 200px);
        gap: 20px;
    }
    
    .courses-sidebar {
        width: 300px;
        background: #f5f5f7;
        border-radius: 12px;
        padding: 20px;
        overflow-y: auto;
    }
    
    .course-item {
        background: #fff;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.2s;
    }
    
    .course-item:hover {
        border-color: #000;
        transform: translateX(5px);
    }
    
    .course-item.dragging {
        opacity: 0.5;
    }
    
    .canvas-container {
        flex: 1;
        background: #fff;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    
    .canvas-header {
        padding: 20px;
        border-bottom: 1px solid #d2d2d7;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .canvas-wrapper {
        width: 100%;
        height: calc(100% - 80px);
        overflow: hidden;
        position: relative;
        background: #fafafa;
        cursor: grab;
    }
    
    .canvas-wrapper.panning {
        cursor: grabbing;
    }
    
    .trajectory-canvas {
        width: 3200px;
        height: 900px;
        position: absolute;
        transform-origin: 0 0;
        transition: transform 0.15s ease-out;
    }
    
    .semester-column {
        position: absolute;
        width: 800px;
        height: 100%;
        border-right: 2px solid #d2d2d7;
    }
    
    .semester-label {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 18px;
        font-weight: 600;
        background: #000;
        color: #fff;
        padding: 8px 16px;
        border-radius: 8px;
        z-index: 10;
    }
    
    .drop-zone {
        position: absolute;
        width: 100%;
        border: 2px dashed transparent;
        transition: all 0.2s;
        min-height: 200px;
    }
    
    .drop-zone-top {
        top: 60px;
        height: 250px;
    }
    
    .drop-zone-center {
        top: 320px;
        height: 250px;
        border-top: 3px solid #000;
        border-bottom: 3px solid #000;
    }
    
    .drop-zone-bottom {
        top: 580px;
        height: 250px;
    }
    
    .drop-zone.drag-over {
        border-color: #000;
        background: rgba(0, 0, 0, 0.05);
    }
    
    .center-line {
        position: absolute;
        top: 445px;
        left: 0;
        right: 0;
        height: 4px;
        background: #000;
        z-index: 1;
        pointer-events: none;
    }
    
    .course-card {
        position: absolute;
        background: #fff;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 12px;
        width: 200px;
        cursor: move;
        transition: transform 0.2s;
        z-index: 10;
    }
    
    .course-card.optional {
        border-style: dashed;
        background: #f5f5f7;
    }
    
    .course-card:hover {
        transform: scale(1.05);
        z-index: 100;
    }
    
    .course-card-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .course-card-category {
        font-size: 11px;
        color: #86868b;
    }
    
    .course-card-remove {
        position: absolute;
        top: -8px;
        right: -8px;
        width: 24px;
        height: 24px;
        background: #ff3b30;
        color: #fff;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 14px;
        display: none;
    }
    
    .course-card:hover .course-card-remove {
        display: block;
    }
    
    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 1000;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        background: #000;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
    }
    
    .zoom-btn:hover {
        background: #333;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="courses-sidebar">
        <h2 style="font-size: 20px; margin-bottom: 20px;">Курсы</h2>
        <input type="text" id="search-courses" placeholder="Поиск курсов" style="margin-bottom: 15px;">
        
        <div id="courses-list">
            {% for course in all_courses %}
            <div class="course-item" draggable="true" 
                 data-course-id="{{ course.id }}" 
                 data-course-title="{{ course.title }}"
                 data-course-category="{{ course.category }}"
                 data-course-description="{{ course.description|truncatewords:10 }}">
                <div style="font-size: 14px; font-weight: 500;">{{ course.title }}</div>
                <div style="font-size: 11px; color: #86868b; margin-top: 4px;">{{ course.category }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="canvas-container">
        <div class="canvas-header">
            <input type="text" id="trajectory-name" 
                   placeholder="Название траектории" 
                   value="{% if trajectory %}{{ trajectory.name }}{% else %}Новая траектория{% endif %}" 
                   style="font-size: 24px; font-weight: 600; border: none; border-bottom: 2px solid transparent; padding: 5px 0; width: 400px;">
            <button id="save-trajectory-btn" class="btn">Сохранить траекторию</button>
        </div>
        
        <div class="canvas-wrapper" id="canvas-wrapper">
            <div class="trajectory-canvas" id="trajectory-canvas">
                <div class="center-line"></div>
                
                <div class="semester-column" style="left: 0px;">
                    <div class="semester-label">1 семестр</div>
                    <div class="drop-zone drop-zone-top" data-semester="1" data-position="top"></div>
                    <div class="drop-zone drop-zone-center" data-semester="1" data-position="center"></div>
                    <div class="drop-zone drop-zone-bottom" data-semester="1" data-position="bottom"></div>
                </div>
                
                <div class="semester-column" style="left: 800px;">
                    <div class="semester-label">2 семестр</div>
                    <div class="drop-zone drop-zone-top" data-semester="2" data-position="top"></div>
                    <div class="drop-zone drop-zone-center" data-semester="2" data-position="center"></div>
                    <div class="drop-zone drop-zone-bottom" data-semester="2" data-position="bottom"></div>
                </div>
                
                <div class="semester-column" style="left: 1600px;">
                    <div class="semester-label">3 семестр</div>
                    <div class="drop-zone drop-zone-top" data-semester="3" data-position="top"></div>
                    <div class="drop-zone drop-zone-center" data-semester="3" data-position="center"></div>
                    <div class="drop-zone drop-zone-bottom" data-semester="3" data-position="bottom"></div>
                </div>
                
                <div class="semester-column" style="left: 2400px;">
                    <div class="semester-label">4 семестр</div>
                    <div class="drop-zone drop-zone-top" data-semester="4" data-position="top"></div>
                    <div class="drop-zone drop-zone-center" data-semester="4" data-position="center"></div>
                    <div class="drop-zone drop-zone-bottom" data-semester="4" data-position="bottom"></div>
                </div>
            </div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoom-out">-</button>
                <button class="zoom-btn" id="zoom-reset">70%</button>
                <button class="zoom-btn" id="zoom-in">+</button>
            </div>
        </div>
    </div>
</div>

<script>
let courses = [];
let zoom = 0.7;
let pan = { x: 50, y: 50 };
let isPanning = false;
let startPan = { x: 0, y: 0 };

const existingData = {{ existing_data|safe }};

document.addEventListener('DOMContentLoaded', function() {
    initDragAndDrop();
    initZoomAndPan();
    initSearch();
    
    document.getElementById('save-trajectory-btn').addEventListener('click', saveTrajectory);
    
    if (Object.keys(existingData).length > 0) {
        loadExistingCourses();
    }
    
    centerCanvas();
    updateTransform();
});

function centerCanvas() {
    const wrapper = document.getElementById('canvas-wrapper');
    const wrapperRect = wrapper.getBoundingClientRect();
    
    pan.x = (wrapperRect.width - 3200 * zoom) / 2 + 100;
    pan.y = (wrapperRect.height - 900 * zoom) / 2;
}

function initDragAndDrop() {
    const courseItems = document.querySelectorAll('.course-item');
    courseItems.forEach(item => {
        item.addEventListener('dragstart', handleDragStart);
        item.addEventListener('dragend', handleDragEnd);
    });
    
    const dropZones = document.querySelectorAll('.drop-zone');
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleDrop);
        zone.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragStart(e) {
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'copy';
    e.dataTransfer.setData('courseId', e.target.dataset.courseId);
    e.dataTransfer.setData('courseTitle', e.target.dataset.courseTitle);
    e.dataTransfer.setData('courseCategory', e.target.dataset.courseCategory);
}

function handleDragEnd(e) {
    e.target.classList.remove('dragging');
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function handleDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const courseId = parseInt(e.dataTransfer.getData('courseId'));
    const courseTitle = e.dataTransfer.getData('courseTitle');
    const courseCategory = e.dataTransfer.getData('courseCategory');
    const semester = parseInt(e.currentTarget.dataset.semester);
    const position = e.currentTarget.dataset.position;
    
    if (courseExistsInTrajectory(courseId)) {
        alert('Этот курс уже добавлен');
        return;
    }
    
    const course = {
        course_id: courseId,
        title: courseTitle,
        category: courseCategory,
        semester: semester,
        position: position,
        order: getCoursesInZone(semester, position).length
    };
    
    courses.push(course);
    renderCourse(course);
}

function courseExistsInTrajectory(courseId) {
    return courses.some(c => c.course_id === courseId);
}

function getCoursesInZone(semester, position) {
    return courses.filter(c => c.semester === semester && c.position === position);
}

function renderCourse(course) {
    const canvas = document.getElementById('trajectory-canvas');
    const card = document.createElement('div');
    card.className = `course-card ${course.position !== 'center' ? 'optional' : ''}`;
    card.dataset.courseId = course.course_id;
    
    const semesterOffset = (course.semester - 1) * 800;
    const coursesInZone = getCoursesInZone(course.semester, course.position);
    
    // Расширяем зону горизонтально
    const cardWidth = 200;
    const gap = 20;
    const totalWidth = coursesInZone.length * (cardWidth + gap);
    const startX = semesterOffset + (800 - totalWidth) / 2;
    const xPosition = startX + course.order * (cardWidth + gap);
    
    let yPosition;
    if (course.position === 'top') yPosition = 120;
    else if (course.position === 'center') yPosition = 360;
    else yPosition = 640;
    
    card.style.left = `${xPosition}px`;
    card.style.top = `${yPosition}px`;
    
    card.innerHTML = `
        <div class="course-card-title">${course.title}</div>
        <div class="course-card-category">${course.category}</div>
        <button class="course-card-remove" onclick="removeCourse(${course.course_id})">×</button>
    `;
    
    canvas.appendChild(card);
}

function removeCourse(courseId) {
    courses = courses.filter(c => c.course_id !== courseId);
    document.querySelectorAll('.course-card').forEach(card => {
        if (parseInt(card.dataset.courseId) === courseId) card.remove();
    });
    reorderCourses();
}

function reorderCourses() {
    document.querySelectorAll('.course-card').forEach(card => card.remove());
    
    const grouped = {};
    courses.forEach(course => {
        const key = `${course.semester}_${course.position}`;
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(course);
    });
    
    Object.keys(grouped).forEach(key => {
        grouped[key].forEach((course, index) => {
            course.order = index;
            renderCourse(course);
        });
    });
}

function loadExistingCourses() {
    Object.keys(existingData).forEach(key => {
        const [semester, position] = key.split('_');
        existingData[key].forEach((courseData, index) => {
            const course = {
                course_id: courseData.course_id,
                title: courseData.title,
                category: courseData.category,
                semester: parseInt(semester),
                position: position,
                order: index
            };
            courses.push(course);
            renderCourse(course);
        });
    });
}

function initZoomAndPan() {
    const wrapper = document.getElementById('canvas-wrapper');
    const canvas = document.getElementById('trajectory-canvas');
    
    document.getElementById('zoom-in').addEventListener('click', () => {
        const oldZoom = zoom;
        zoom = Math.min(zoom + 0.1, 1.5);
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = wrapperRect.width / 2;
        const centerY = wrapperRect.height / 2;
        
        pan.x = centerX - (centerX - pan.x) * (zoom / oldZoom);
        pan.y = centerY - (centerY - pan.y) * (zoom / oldZoom);
        
        updateTransform();
    });
    
    document.getElementById('zoom-out').addEventListener('click', () => {
        const oldZoom = zoom;
        zoom = Math.max(zoom - 0.1, 0.3);
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = wrapperRect.width / 2;
        const centerY = wrapperRect.height / 2;
        
        pan.x = centerX - (centerX - pan.x) * (zoom / oldZoom);
        pan.y = centerY - (centerY - pan.y) * (zoom / oldZoom);
        
        updateTransform();
    });
    
    document.getElementById('zoom-reset').addEventListener('click', () => {
        zoom = 0.7;
        centerCanvas();
        updateTransform();
    });
    
    wrapper.addEventListener('mousedown', (e) => {
        if (e.target === wrapper || e.target === canvas || e.target.classList.contains('drop-zone') || e.target.classList.contains('center-line')) {
            isPanning = true;
            startPan = { x: e.clientX - pan.x, y: e.clientY - pan.y };
            wrapper.classList.add('panning');
        }
    });
    
    wrapper.addEventListener('mousemove', (e) => {
        if (isPanning) {
            pan.x = e.clientX - startPan.x;
            pan.y = e.clientY - startPan.y;
            updateTransform();
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            wrapper.classList.remove('panning');
        }
    });
    
    wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? -0.05 : 0.05;
        const oldZoom = zoom;
        zoom = Math.max(0.3, Math.min(1.5, zoom + delta));
        
        const rect = wrapper.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        pan.x = mouseX - (mouseX - pan.x) * (zoom / oldZoom);
        pan.y = mouseY - (mouseY - pan.y) * (zoom / oldZoom);
        
        updateTransform();
    }, { passive: false });
}

function updateTransform() {
    const canvas = document.getElementById('trajectory-canvas');
    canvas.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`;
    document.getElementById('zoom-reset').textContent = `${Math.round(zoom * 100)}%`;
}

function initSearch() {
    document.getElementById('search-courses').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        document.querySelectorAll('.course-item').forEach(item => {
            item.style.display = item.dataset.courseTitle.toLowerCase().includes(query) ? 'block' : 'none';
        });
    });
}

function saveTrajectory() {
    const name = document.getElementById('trajectory-name').value;
    
    if (!name.trim() || courses.length === 0) {
        alert('Заполните название и добавьте курсы');
        return;
    }
    
    fetch('{% url "save_trajectory" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            {% if trajectory %}trajectory_id: {{ trajectory.id }},{% endif %}
            name: name,
            courses: courses
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) window.location.href = `/trajectory/${data.trajectory_id}/`;
    })
    .catch(() => alert('Ошибка сохранения'));
}
</script>
{% endblock %}