{% extends 'base.html' %}

{% block title %}Траектории обучения{% endblock %}

{% block extra_css %}
<style>
    .trajectory-tree {
        width: 100%;
        height: 800px;
        overflow: hidden;
        background: #fafafa;
        border: 1px solid #d2d2d7;
        border-radius: 12px;
        position: relative;
        cursor: grab;
    }
    
    .trajectory-tree.panning {
        cursor: grabbing;
    }
    
    .tree-canvas {
        width: 3200px;
        height: 900px;
        position: absolute;
        transform-origin: 0 0;
    }
    
    .semester-section {
        position: absolute;
        width: 800px;
        height: 100%;
        border-right: 2px solid #d2d2d7;
    }
    
    .semester-header {
        position: absolute;
        top: 20px;
        left: 20px;
        font-size: 18px;
        font-weight: 600;
        background: #000;
        color: #fff;
        padding: 8px 16px;
        border-radius: 8px;
        z-index: 10;
    }
    
    .main-line {
        position: absolute;
        top: 445px;
        left: 0;
        right: 0;
        height: 4px;
        background: #000;
        z-index: 1;
        pointer-events: none;
    }
    
    .course-node {
        position: absolute;
        background: #fff;
        border: 2px solid #000;
        border-radius: 8px;
        padding: 12px;
        width: 180px;
        cursor: pointer;
        transition: all 0.2s;
        z-index: 10;
        text-decoration: none;
        color: inherit;
        display: block;
    }
    
    .course-node.optional {
        border-style: dashed;
        background: #f5f5f7;
    }
    
    .course-node:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 100;
    }
    
    .course-node-title {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
    }
    
    .course-node-category {
        font-size: 10px;
        color: #86868b;
        margin-bottom: 8px;
    }
    
    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 1000;
    }
    
    .zoom-btn {
        width: 40px;
        height: 40px;
        background: #000;
        color: #fff;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
    <div>
        <h1>Траектории обучения</h1>
        <p style="font-size: 18px; color: #86868b;">Личные и преподавательские траектории</p>
    </div>
    <a href="{% url 'create_trajectory' %}" class="btn">+ Создать траекторию</a>
</div>

{% if all_trajectories %}
<h2 style="margin-bottom: 20px;">Ваши траектории</h2>
<div class="grid">
    {% for traj in all_trajectories %}
    <div class="card" style="position: relative; padding-bottom: 60px;">
        <a href="{% url 'trajectory' traj.id %}" style="text-decoration: none; color: inherit;">
            <div style="cursor: pointer;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                    <h3 style="font-size: 18px; margin: 0; flex: 1; margin-right: 10px;">{{ traj.name }}</h3>
                    <span style="font-size: 10px; background: {% if traj.trajectory_type == 'personal' %}#000{% else %}#666{% endif %}; color: #fff; padding: 4px 8px; border-radius: 4px; white-space: nowrap;">
                        {% if traj.trajectory_type == 'personal' %}Личная{% else %}От преподавателя{% endif %}
                    </span>
                </div>
                <p style="font-size: 12px; color: #86868b;">{{ traj.courses.count }} курсов</p>
                {% if traj.teacher %}
                <p style="font-size: 12px; color: #86868b; margin-top: 8px;">Преподаватель: {{ traj.teacher.username }}</p>
                {% endif %}
            </div>
        </a>
        
        <form method="post" action="{% url 'delete_trajectory' traj.id %}" style="position: absolute; bottom: 15px; right: 15px;">
            {% csrf_token %}
            <button type="submit" style="background: #000; border: none; cursor: pointer; font-size: 14px; color: #fff; width: 30px; height: 30px; border-radius: 4px; display: flex; align-items: center; justify-content: center;" 
                    onclick="return confirm('Удалить траекторию?')">×</button>
        </form>
    </div>
    {% endfor %}
</div>
{% else %}
<div style="text-align: center; padding: 60px 0;">
    <p style="font-size: 18px; color: #86868b; margin-bottom: 20px;">У вас пока нет траекторий</p>
    <a href="{% url 'create_trajectory' %}" class="btn">Создать первую траекторию</a>
</div>
{% endif %}

{% if trajectory %}
<div style="margin-top: 60px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>{{ trajectory.name }}</h2>
        <a href="{% url 'trajectory_editor' trajectory.id %}" class="btn btn-outline">Редактировать</a>
    </div>
    
    <div class="trajectory-tree" id="trajectory-tree">
        <div class="tree-canvas" id="tree-canvas">
            <div class="main-line"></div>
            
            <div class="semester-section" style="left: 0px;">
                <div class="semester-header">1 семестр</div>
            </div>
            <div class="semester-section" style="left: 800px;">
                <div class="semester-header">2 семестр</div>
            </div>
            <div class="semester-section" style="left: 1600px;">
                <div class="semester-header">3 семестр</div>
            </div>
            <div class="semester-section" style="left: 2400px;">
                <div class="semester-header">4 семестр</div>
            </div>
        </div>
        
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-out">-</button>
            <button class="zoom-btn" id="zoom-reset">70%</button>
            <button class="zoom-btn" id="zoom-in">+</button>
        </div>
    </div>
</div>

<script>
const coursesData = {{ courses_json|safe }};

let zoom = 0.7;
let pan = { x: 50, y: 50 };
let isPanning = false;
let startPan = { x: 0, y: 0 };

document.addEventListener('DOMContentLoaded', function() {
    console.log('Courses data:', coursesData);
    renderTrajectoryTree();
    initZoomAndPan();
});

function renderTrajectoryTree() {
    const canvas = document.getElementById('tree-canvas');
    
    coursesData.forEach(course => {
        const node = createCourseNode(course);
        canvas.appendChild(node);
    });
    
    updateTransform();
}

function createCourseNode(course) {
    const node = document.createElement('a');
    node.href = `/course/${course.course_id}/`;
    node.className = `course-node ${course.position !== 'center' ? 'optional' : ''}`;
    
    const semesterOffset = (course.semester - 1) * 800;
    const coursesInZone = coursesData.filter(c => c.semester === course.semester && c.position === course.position);
    
    const cardWidth = 180;
    const gap = 20;
    const totalWidth = coursesInZone.length * (cardWidth + gap);
    const startX = semesterOffset + (800 - totalWidth) / 2;
    const xPosition = startX + course.order * (cardWidth + gap);
    
    let yPosition;
    if (course.position === 'top') yPosition = 120;
    else if (course.position === 'center') yPosition = 360;
    else yPosition = 640;
    
    node.style.left = `${xPosition}px`;
    node.style.top = `${yPosition}px`;
    
    node.innerHTML = `
        <div class="course-node-title">${course.title}</div>
        <div class="course-node-category">${course.category}</div>
    `;
    
    return node;
}

function initZoomAndPan() {
    const wrapper = document.getElementById('trajectory-tree');
    const canvas = document.getElementById('tree-canvas');
    
    document.getElementById('zoom-in').addEventListener('click', () => {
        const oldZoom = zoom;
        zoom = Math.min(zoom + 0.1, 1.5);
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = wrapperRect.width / 2;
        const centerY = wrapperRect.height / 2;
        
        pan.x = centerX - (centerX - pan.x) * (zoom / oldZoom);
        pan.y = centerY - (centerY - pan.y) * (zoom / oldZoom);
        
        updateTransform();
    });
    
    document.getElementById('zoom-out').addEventListener('click', () => {
        const oldZoom = zoom;
        zoom = Math.max(zoom - 0.1, 0.3);
        
        const wrapperRect = wrapper.getBoundingClientRect();
        const centerX = wrapperRect.width / 2;
        const centerY = wrapperRect.height / 2;
        
        pan.x = centerX - (centerX - pan.x) * (zoom / oldZoom);
        pan.y = centerY - (centerY - pan.y) * (zoom / oldZoom);
        
        updateTransform();
    });
    
    document.getElementById('zoom-reset').addEventListener('click', () => {
        zoom = 0.7;
        const wrapperRect = wrapper.getBoundingClientRect();
        pan.x = (wrapperRect.width - 3200 * zoom) / 2 + 100;
        pan.y = (wrapperRect.height - 900 * zoom) / 2;
        updateTransform();
    });
    
    wrapper.addEventListener('mousedown', (e) => {
        if (e.target === wrapper || e.target === canvas || e.target.classList.contains('semester-section')) {
            isPanning = true;
            startPan = { x: e.clientX - pan.x, y: e.clientY - pan.y };
            wrapper.classList.add('panning');
        }
    });
    
    wrapper.addEventListener('mousemove', (e) => {
        if (isPanning) {
            pan.x = e.clientX - startPan.x;
            pan.y = e.clientY - startPan.y;
            updateTransform();
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isPanning) {
            isPanning = false;
            wrapper.classList.remove('panning');
        }
    });
    
    wrapper.addEventListener('wheel', (e) => {
        e.preventDefault();
        
        const delta = e.deltaY > 0 ? -0.05 : 0.05;
        const oldZoom = zoom;
        zoom = Math.max(0.3, Math.min(1.5, zoom + delta));
        
        const rect = wrapper.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;
        
        pan.x = mouseX - (mouseX - pan.x) * (zoom / oldZoom);
        pan.y = mouseY - (mouseY - pan.y) * (zoom / oldZoom);
        
        updateTransform();
    }, { passive: false });
    
    // Центрируем при загрузке
    const wrapperRect = wrapper.getBoundingClientRect();
    pan.x = (wrapperRect.width - 3200 * zoom) / 2 + 100;
    pan.y = (wrapperRect.height - 900 * zoom) / 2;
    updateTransform();
}

function updateTransform() {
    const canvas = document.getElementById('tree-canvas');
    canvas.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoom})`;
    document.getElementById('zoom-reset').textContent = `${Math.round(zoom * 100)}%`;
}
</script>
{% endif %}
{% endblock %}